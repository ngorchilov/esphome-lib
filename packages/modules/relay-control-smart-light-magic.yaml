substitutions:
  # Home Assistant light entity to control (override this from the main device YAML)
  ha_light_entity: light.example_light

  rocker_timeout: 1ms

packages:
  # TODO: Fix magic_switch component to support !extend and inherit relay-control-light-mmagic instead of duplicating its content
  Base: github://ngorchilov/esphome-lib/packages/modules/relay-control-light.yaml

external_components:
  - source: github://ssieb/esphome_components
    components: [magic_switch]

switch:
  - id: !extend relay_switch
    internal: true

binary_sensor:
  - id: !remove rocker_switch

  - platform: template
    name: Rocker Switch
    id: rocker_switch_virtual
    lambda: return {};

magic_switch:
  id: rocker_switch
  pin:
    number: ${rocker_pin}
    inverted: ${rocker_inverted}
    mode:
      input: true
      pullup: ${rocker_inverted}
      pulldown: ${not rocker_inverted}
    ignore_strapping_warning: ${rocker_strapping}
  timeout: ${rocker_timeout}
  on_switch:
    - homeassistant.action:
        action: light.toggle
        data:
          entity_id: ${ha_light_entity}
    - binary_sensor.template.publish:
        id: rocker_switch_virtual
        state: !lambda 'return !id(rocker_switch_virtual).state;'
